<!DOCTYPE html>
<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
<div id="temperatureDiv" style="width:1100px;height:250px;"></div>
<div id="batteryDiv" style="width:1100px;height:250px;"></div>


<script>
//************ Temperatures **************
var temperature_ys = [];
var temperature_xs = [];

var temperatures = {
  x: temperature_xs,
  y: temperature_ys,
  mode: 'lines',
  name: 'iSpindel',
  connectgaps: true,
  line: {
    color: 'rgb(0, 0, 150)',
    width: 1
  }
};

var temperatureData = [temperatures];

var temperatureLayout = {
  title:'iSpindel',
  xaxis: {
//    title: 'Date / Time'
  },
  yaxis: {
    title: 'Temperatue &#176;C'
  },
  paper_bgcolor: '#f5f5f5',
  plot_bgcolor: '#eeeeff',
  margin:{
    t: 25,
    r: 10,
    l: 55,
    b: 30
  }
};

Plotly.newPlot('temperatureDiv', temperatureData, temperatureLayout);

function clearData(anArray){
    while(anArray.length>0){anArray.pop();}
}

function fetchTemperaturesJson(){
  fetch("/brewery/temperatures")
  .then(function (response) {
    return response.json();
  })
  .then(function (myJson) {
    clearData(temperature_ys);
    clearData(temperature_xs);

    //add new data.
    for(var n=0; n<myJson.temperature.length; n++){
      temperature_ys.push(myJson.temperature[n]);
      temperature_xs.push(myJson.dateTime[n]);
    }

//    Plotly.update??
    Plotly.newPlot('temperatureDiv', temperatureData, temperatureLayout);
    setTimeout(fetchTemperaturesJson, 5000);
  })
  .catch(function (error) {
    console.log("Error: " + error);
  });
}

setTimeout(fetchTemperaturesJson, 500);


//************ Battery Graph **************
var battery_ys = [];
var battery_xs = [];

var battery = {
  x: battery_xs,
  y: battery_ys,
  mode: 'lines',
  name: 'iSpindel',
  connectgaps: true,
  line: {
    color: 'rgb(0, 0, 150)',
    width: 1
  }
};

var batteryData = [battery];

var batteryLayout = {
  title:'iSpindel',
  xaxis: {
//    title: 'Date / Time'
  },
  yaxis: {
    title: 'volts'
  },
  paper_bgcolor: '#f5f5f5',
  plot_bgcolor: '#eeeeff',
  margin:{
    t: 25,
    r: 10,
    l: 55,
    b: 30
  }
};

Plotly.newPlot('batteryDiv', batteryData, batteryLayout);

function fetchBatteryJson(){
  fetch("/brewery/batteries")
  .then(function (response) {
    return response.json();
  })
  .then(function (myJson) {
    clearData(battery_ys);
    clearData(battery_xs);

    //add new data.
    for(var n=0; n<myJson.batteries.length; n++){
      battery_ys.push(myJson.batteries[n]);
      battery_xs.push(myJson.dateTime[n]);
    }

//    Plotly.update??
    Plotly.newPlot('batteryDiv', batteryData, batteryLayout);
    setTimeout(fetchBatteryJson, 5000);
  })
  .catch(function (error) {
    console.log("Error: " + error);
  });
}


// ******************* Initial load of graph data
fetchTemperaturesJson();
fetchBatteryJson();
</script>
</body>
</html>
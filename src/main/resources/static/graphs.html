<!DOCTYPE html>
<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
<div id="temperatureDiv" style="width:1200px;height:200px;"></div>
<div id="gravityDiv" style="width:1200px;height:200px;"></div>
<div id="batteryDiv" style="width:1200px;height:200px;"></div>

<script>
//************** Common **********
function getLayout(aTitle, yAxisTitle){
    var layout = {
        title:aTitle,
        xaxis: {
            //title: 'Date / Time'
        },
        yaxis: {
            title: yAxisTitle
        },
        paper_bgcolor: '#fefefe',
        plot_bgcolor: '#eeeeff',
        margin:{
            t: 25,
            r: 10,
            l: 55,
            b: 30
        }
    };
    return layout;
}

function buildData(xs, ys, aName){
    var theData = {
        x: xs,
        y: ys,
        mode: 'lines',
        name: aName,
        connectgaps: true,
        line: {
            color: 'rgb(0, 0, 150)',
            width: 1
        }
    };
    return theData;
}

function clearData(anArray){
    while(anArray.length>0){anArray.pop();}
}

function refreshData(xs, ys, dateTime, theData){
    clearData(ys);
    clearData(xs);

    for(n=0; n<dateTime.length; n++){
      ys.push(theData[n]);
      xs.push(dateTime[n]);
    }
}

//************ Temperatures **************
var temperature_ys = [];
var temperature_xs = [];
var temperatures = buildData(temperature_xs, temperature_ys, 'iSpindel');
var temperatureData = [temperatures];
var temperatureLayout = getLayout('Temperature','&#176;Celsius');
Plotly.newPlot('temperatureDiv', temperatureData, temperatureLayout);

function fetchTemperaturesJson(){
  fetch("/brewery/temperatures")
  .then(function (response) {
    return response.json();
  })
  .then(function (myJson) {
    refreshData(temperature_xs, temperature_ys,myJson.dateTime, myJson.temperature);
    Plotly.update('temperatureDiv', temperatureData, temperatureLayout);
    setTimeout(fetchTemperaturesJson, 5000);
  })
  .catch(function (error) {
    console.log("Error: " + error);
  });
}

//************ Battery Graph **************
var battery_ys = [];
var battery_xs = [];
var battery = buildData(battery_xs, battery_ys, 'iSpindel Battery');
var batteryData = [battery];
var batteryLayout = getLayout('iSpindel Battery', 'Volts');
Plotly.newPlot('batteryDiv', batteryData, batteryLayout);

function fetchBatteryJson(){
  fetch("/brewery/batteries")
  .then(function (response) {
    return response.json();
  })
  .then(function (myJson) {
    refreshData(battery_xs, battery_ys,myJson.dateTime, myJson.batteries);
    Plotly.update('batteryDiv', batteryData, batteryLayout);
    setTimeout(fetchBatteryJson, 5000);
  })
  .catch(function (error) {
    console.log("Error: " + error);
  });
}

//************ Gravity Graph **************
var gravity_ys = [];
var gravity_xs = [];
var gravity = buildData(gravity_xs, gravity_ys, 'Gravity');
var gravityData = [gravity];
var gravityLayout = getLayout('Gravity', 'SG');
Plotly.newPlot('gravityDiv', gravityData, gravityLayout);

function fetchGravityJson(){
  fetch("/brewery/gravities")
  .then(function (response) {
    return response.json();
  })
  .then(function (myJson) {
    refreshData(gravity_xs, gravity_ys, myJson.dateTime, myJson.gravities);
    Plotly.update('gravityDiv', gravityData, gravityLayout);
    setTimeout(fetchGravityJson, 5000);
  })
  .catch(function (error) {
    console.log("Error: " + error);
  });
}


// ******************* Initial load of graph data
fetchTemperaturesJson();
fetchBatteryJson();
fetchGravityJson();
</script>
</body>
</html>